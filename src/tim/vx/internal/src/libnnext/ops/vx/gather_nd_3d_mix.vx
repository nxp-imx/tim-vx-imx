#include "cl_viv_vx_ext.h"

_viv_uniform VXC_512Bits uniConvertInt8toFp16_2x8;

_viv_uniform int2 multAndoutZP0;//[0:15] multiplier, [31:63] output zp
_viv_uniform VXC_512Bits uniU8MulAndPostShift_0_Lo_2x8;

_viv_uniform VXC_512Bits uinConvertFp16ToInt8_2x8;

_viv_uniform VXC_512Bits uniConvertFp16toU8_2x8;
_viv_uniform int2 multAndoutZP1;//[0:15] multiplier, [31:63] output zp

#define GATHER_ND_QINT_TO_F16_3D(src0_type_name, read_type) \
__kernel void gather_nd_##src0_type_name##toF16_3D( \
    __read_only image2d_array_t   input0, \
    __read_only image2d_t   input1, \
    __write_only image2d_t  output, \
    int block_size, \
    int coord_dim \
    ) \
{ \
    int gidx = get_global_id(0); \
    int gidy = get_global_id(1); \
 \
    int4 coord = (int4)(0, gidy, gidx, 0); \
    int4 indice = read_imagei(input1, coord.xy); \
    indice.x = indice.x * block_size + gidx; \
    indice.w = 0; \
 \
    read_type src; \
    VXC_ReadImage2DArray(src, input0, indice, 0, VXC_MODIFIER(0, 0, 0, VXC_RM_TowardZero, 0)); \
 \
    vxc_half8  src0; \
    vxc_short8 dst0; \
    vxc_ushort8 ms0; \
    _viv_asm(COPY, ms0, multAndoutZP0, 16); \
    VXC_DP2x8(src0,src,ms0,VXC_MODIFIER(0,7,0,VXC_RM_TowardZero,1),uniU8MulAndPostShift_0_Lo_2x8); \
    _viv_asm(COPY, dst0, src0, 16); \
    VXC_WriteImage(output, coord.zy, dst0, VXC_MODIFIER(0, 0, 0, VXC_RM_TowardZero, 0)); \
}
GATHER_ND_QINT_TO_F16_3D(U8, vxc_uchar16)
GATHER_ND_QINT_TO_F16_3D(I8, vxc_char16)
GATHER_ND_QINT_TO_F16_3D(I16, vxc_short8)

#define GATHER_ND_F16_TO_QINT_3D(src1_type_name, write_type) \
__kernel void gather_nd_F16to##src1_type_name##_3D( \
    __read_only image2d_array_t   input0, \
    __read_only image2d_t   input1, \
    __write_only image2d_t  output, \
    int block_size, \
    int coord_dim \
    ) \
{ \
    int gidx = get_global_id(0); \
    int gidy = get_global_id(1); \
 \
    int4 coord = (int4)(0, gidy, gidx, 0); \
    int4 indice = read_imagei(input1, coord.xy); \
    indice.x = indice.x * block_size + gidx; \
    indice.w = 0; \
 \
    vxc_short8 src; \
    VXC_ReadImage2DArray(src, input0, indice, 0, VXC_MODIFIER(0, 0, 0, VXC_RM_TowardZero, 0)); \
 \
    vxc_ushort8 mp1; \
    _viv_asm(COPY, mp1, multAndoutZP1, 16); \
    vxc_half8 data; \
    write_type dst; \
    _viv_asm(COPY, data, src, 16); \
    VXC_DP2x8(dst,data,mp1,VXC_MODIFIER(0,7,0,VXC_RM_ToNearestEven,1), uniConvertFp16toU8_2x8); \
    VXC_WriteImage(output, coord.zy, dst, VXC_MODIFIER(0, 0, 0, VXC_RM_TowardZero, 0)); \
}
GATHER_ND_F16_TO_QINT_3D(U8, vxc_uchar16)
GATHER_ND_F16_TO_QINT_3D(I8, vxc_char16)
GATHER_ND_F16_TO_QINT_3D(I16, vxc_short8)

